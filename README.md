Out-of-tree implementation of https://github.com/NixOS/rfcs/pull/10
